<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tation清单</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css" />
    <style>
        :root { --van-primary-color: #1989fa; }
        body { background-color: #f2f6fc; padding-bottom: 110px; margin: 0; -webkit-font-smoothing: antialiased; }
        #capture-area { background-color: #f2f6fc; padding: 1px 0; }
        
        /* 导航栏修复 */
        .van-nav-bar__title { max-width: 60%; font-weight: bold; }

        /* 卡片与间距优化 */
        .list-card { margin: 10px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(25, 137, 250, 0.08); }
        .group-header { padding: 12px; background: #1989fa; color: white; display: flex; justify-content: space-between; align-items: center; }
        .group-title { font-size: 15px; font-weight: bold; flex: 1; padding-right: 8px; line-height: 1.4; }
        
        .category-title { padding: 6px 12px; background: #eef5fe; color: #1989fa; font-size: 12px; font-weight: bold; border-bottom: 1px solid #d1e3f9; }
        
        /* 列表行：优化文字展示 */
        .item-row { display: flex; align-items: flex-start; padding: 12px; border-bottom: 1px solid #ebedf0; background: white; }
        .item-info { flex: 1; margin: 0 8px; min-width: 0; /* 必须加这行才能让文本溢出生效 */ }
        
        /* 智能换行逻辑：10字以内通常不换行，长文本支持换行 */
        .item-name { 
            font-size: 15px; 
            color: #323233; 
            line-height: 1.4;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 最多显示2行，防止内容过长 */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .completed { text-decoration: line-through; color: #c8c9cc !important; }
        .remark { font-size: 12px; color: #969799; margin-top: 4px; line-height: 1.3; }

        /* 底部操作 */
        .footer-bar { position: fixed; bottom: 0; width: 100%; display: flex; background: rgba(255,255,255,0.95); padding: 12px; box-sizing: border-box; border-top: 1px solid #ebedf0; z-index: 100; backdrop-filter: blur(10px); }
        .no-print { display: flex; gap: 8px; width: 100%; }
        
        .hide-for-pic .action-icon { display: none !important; }
    </style>
</head>
<body>
    <div id="app">
        <div id="capture-area" :class="{'hide-for-pic': isExporting}">
            <van-nav-bar title="Tation清单" class="no-print"></van-nav-bar>

            <div v-for="(group, gIndex) in groups" :key="gIndex" class="list-card">
                <div class="group-header">
                    <div class="group-title">{{ group.name }}</div>
                    <van-icon name="delete-o" size="18" @click="removeGroup(gIndex)" class="action-icon no-print" />
                </div>

                <div v-for="(cat, cName) in group.categories" :key="cName">
                    <div class="category-title">{{ cName }}</div>
                    <div v-for="(item, iIndex) in cat" :key="iIndex" class="item-row">
                        <van-checkbox v-model="item.checked" checked-color="#1989fa" @change="saveData" class="action-icon" style="margin-top: 2px;"></van-checkbox>
                        <div class="item-info" @click="item.checked = !item.checked; saveData()">
                            <div class="item-name" :class="{ completed: item.checked }">{{ item.name }}</div>
                            <div v-if="item.remark" class="remark" :class="{ completed: item.checked }">{{ item.remark }}</div>
                        </div>
                        <van-icon name="clear" size="18" color="#eeeeee" @click.stop="removeItem(gIndex, cName, iIndex)" class="action-icon no-print" />
                    </div>
                </div>

                <div class="no-print" style="padding: 10px;">
                    <van-button size="small" icon="plus" plain type="primary" block round @click="openItemDialog(gIndex)">添加物品</van-button>
                </div>
            </div>
            <van-empty v-if="groups.length === 0" description="点击下方按钮开始创建" />
        </div>

        <div class="footer-bar no-print">
            <van-button icon="photo-o" type="primary" plain round @click="exportImage" :loading="isExporting" style="flex: 1;">长图</van-button>
            <van-button icon="plus" type="primary" round @click="showAddGroup = true" style="flex: 2;">新建模块</van-button>
        </div>

        <van-dialog v-model:show="itemDialog" title="添加食材" show-cancel-button @confirm="addItem">
            <van-cell-group inset style="margin-top: 10px;">
                <van-field v-model="tempItem.catName" label="分类" placeholder="如：肉类"></van-field>
                <van-field v-model="tempItem.name" label="名称" placeholder="请输入食材名称" autosize type="textarea" rows="1"></van-field>
                <van-field v-model="tempItem.remark" label="备注" placeholder="购买渠道等" autosize type="textarea" rows="1"></van-field>
            </van-cell-group>
        </van-dialog>

        <van-dialog v-model:show="showAddGroup" title="新建模块" show-cancel-button @confirm="addGroup">
            <van-field v-model="newGroupName" placeholder="如：1、火锅食材" style="padding: 20px;"></van-field>
        </van-dialog>
    </div>

    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;
        createApp({
            setup() {
                const groups = ref([]);
                const isExporting = ref(false);
                const showAddGroup = ref(false);
                const newGroupName = ref('');
                const itemDialog = ref(false);
                const currentGroupIndex = ref(null);
                const tempItem = ref({ catName: '', name: '', remark: '' });

                onMounted(() => {
                    const saved = localStorage.getItem('tation_list_data');
                    if (saved) {
                        groups.value = JSON.parse(saved);
                    } else {
                        groups.value = [
                            { name: "1、火锅食材", categories: { "肉类": [{ name: "牛肉卷", remark: "网购/山姆", checked: false }] } }
                        ];
                    }
                });

                const saveData = () => localStorage.setItem('tation_list_data', JSON.stringify(groups.value));
                
                const addGroup = () => {
                    if (newGroupName.value) {
                        groups.value.push({ name: newGroupName.value, categories: {} });
                        newGroupName.value = '';
                        saveData();
                    }
                };

                const openItemDialog = (gIndex) => {
                    currentGroupIndex.value = gIndex;
                    tempItem.value = { catName: '', name: '', remark: '' };
                    itemDialog.value = true;
                };

                const addItem = () => {
                    const g = groups.value[currentGroupIndex.value];
                    const cat = tempItem.value.catName || '其他';
                    if (!g.categories[cat]) g.categories[cat] = [];
                    g.categories[cat].push({ name: tempItem.value.name, remark: tempItem.value.remark, checked: false });
                    saveData();
                };

                const removeItem = (gIndex, catName, iIndex) => {
                    groups.value[gIndex].categories[catName].splice(iIndex, 1);
                    if (groups.value[gIndex].categories[catName].length === 0) delete groups.value[gIndex].categories[catName];
                    saveData();
                };

                const removeGroup = (index) => {
                    vant.showConfirmDialog({ message: '确定删除此模块？' }).then(() => {
                        groups.value.splice(index, 1);
                        saveData();
                    });
                };

                const exportImage = () => {
                    isExporting.value = true;
                    setTimeout(() => {
                        html2canvas(document.getElementById('capture-area'), { scale: 2, backgroundColor: '#f2f6fc' }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `Tation清单.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                            isExporting.value = false;
                        });
                    }, 300);
                };

                return { groups, isExporting, showAddGroup, newGroupName, itemDialog, tempItem, openItemDialog, addItem, addGroup, removeGroup, removeItem, exportImage, saveData };
            }
        }).use(vant).mount('#app');
    </script>
</body>
</html>
