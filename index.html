<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tation清单</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css" />
    <style>
        :root {
            --van-primary-color: #2f74ff;
            --van-background-2: #f7f8fa;
        }
        body {
            background-color: #f7f8fa;
            /* 适配 iPhone 底部安全区域 */
            padding-bottom: calc(120px + env(safe-area-inset-bottom));
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        /* 顶部导航美化 */
        .van-nav-bar { background: transparent; }
        .van-nav-bar__title { font-weight: 800; font-size: 18px; color: #1a1a1a; }

        /* 卡片容器：增加阴影和圆角 */
        .list-card {
            margin: 16px;
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
        }

        /* 模块标题栏：渐变色 */
        .group-header {
            padding: 16px;
            background: linear-gradient(135deg, #4b89ff, #2f74ff);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-title {
            font-size: 17px;
            font-weight: bold;
            line-height: 1.4;
            flex: 1;
        }

        /* 分类标题：小清新风格 */
        .category-tag {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #8a8a8e;
            background-color: #fafafa;
        }

        /* 列表行：解决遮挡和截断 */
        .item-row {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            background: white;
            transition: background 0.2s;
        }
        .item-row:active { background-color: #f2f2f2; }
        .item-row:not(:last-child) { border-bottom: 0.5px solid #f2f2f2; }

        .checkbox-col { padding-top: 2px; }
        
        .content-col {
            flex: 1;
            margin: 0 12px;
            min-width: 0; /* 允许换行 */
        }
        .item-name {
            font-size: 16px;
            color: #1c1c1e;
            line-height: 1.5;
            word-wrap: break-word; /* 自动换行 */
            font-weight: 500;
        }
        .remark {
            font-size: 13px;
            color: #8e8e93;
            margin-top: 4px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .completed {
            text-decoration: line-through;
            color: #d1d1d6 !important;
        }

        /* 底部操作台：适配灵动岛机型底部横条 */
        .footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 16px 16px calc(16px + env(safe-area-inset-bottom));
            display: flex;
            gap: 12px;
            border-top: 0.5px solid #e5e5ea;
            z-index: 1000;
        }

        /* 导出图片时的状态 */
        .hide-for-pic .action-icon, .hide-for-pic .no-print {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="capture-area" :class="{'hide-for-pic': isExporting}">
            <van-nav-bar title="Tation清单" class="no-print"></van-nav-bar>

            <div v-for="(group, gIndex) in groups" :key="gIndex" class="list-card">
                <div class="group-header">
                    <div class="group-title">{{ group.name }}</div>
                    <van-icon name="delete-o" size="20" @click.stop="removeGroup(gIndex)" class="action-icon no-print" />
                </div>

                <div v-for="(catItems, cName) in group.categories" :key="cName">
                    <div class="category-tag">{{ cName }}</div>
                    
                    <div v-for="(item, iIndex) in catItems" :key="iIndex" class="item-row" @click="toggleCheck(item)">
                        <div class="checkbox-col action-icon">
                            <van-checkbox v-model="item.checked" icon-size="22px"></van-checkbox>
                        </div>
                        <div class="content-col">
                            <div class="item-name" :class="{ completed: item.checked }">{{ item.name }}</div>
                            <div v-if="item.remark" class="remark" :class="{ completed: item.checked }">{{ item.remark }}</div>
                        </div>
                        <div class="action-icon no-print">
                            <van-icon name="cross" size="16" color="#c7c7cc" @click.stop="removeItem(gIndex, cName, iIndex)" />
                        </div>
                    </div>
                </div>

                <div class="no-print" style="padding: 16px;">
                    <van-button size="normal" icon="plus" plain type="primary" block round @click="openItemDialog(gIndex)">添加物品</van-button>
                </div>
            </div>

            <van-empty v-if="groups.length === 0" description="点击下方新建模块开始"></van-empty>
        </div>

        <div class="footer-bar no-print">
            <van-button icon="photo-o" type="primary" plain round @click="exportImage" :loading="isExporting" style="flex: 1; height: 48px;">长图</van-button>
            <van-button icon="plus" type="primary" round @click="showAddGroup = true" style="flex: 2; height: 48px; font-weight: bold;">新建清单模块</van-button>
        </div>

        <van-action-sheet v-model:show="itemDialog" title="添加新项目">
            <div style="padding: 16px 16px 32px;">
                <van-cell-group inset>
                    <van-field v-model="tempItem.catName" label="分类" placeholder="如：肉类 / 蔬菜" is-link readonly @click="showPicker = true"></van-field>
                    <van-field v-model="tempItem.name" label="名称" placeholder="请输入物品名称" rows="1" autosize type="textarea"></van-field>
                    <van-field v-model="tempItem.remark" label="备注" placeholder="渠道或要求" rows="1" autosize type="textarea"></van-field>
                </van-cell-group>
                <div style="margin: 16px;">
                    <van-button block type="primary" round @click="addItem">确认添加</van-button>
                </div>
            </div>
        </van-action-sheet>

        <van-popup v-model:show="showPicker" round position="bottom">
            <van-picker :columns="commonCats" @confirm="onCatConfirm" @cancel="showPicker = false" title="选择分类"></van-picker>
        </van-popup>

        <van-dialog v-model:show="showAddGroup" title="新建清单模块" show-cancel-button @confirm="addGroup">
            <van-field v-model="newGroupName" placeholder="例如：1、火锅食材" style="padding: 24px;" maxlength="20" show-word-limit></van-field>
        </van-dialog>
    </div>

    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const groups = ref([]);
                const isExporting = ref(false);
                const showAddGroup = ref(false);
                const newGroupName = ref('');
                const itemDialog = ref(false);
                const showPicker = ref(false);
                const currentGroupIndex = ref(null);
                const tempItem = ref({ catName: '肉类', name: '', remark: '' });
                const commonCats = [
                    { text: '肉类', value: '肉类' },
                    { text: '蔬菜类', value: '蔬菜类' },
                    { text: '底料类', value: '底料类' },
                    { text: '水果类', value: '水果类' },
                    { text: '饮品类', value: '饮品类' },
                    { text: '其他', value: '其他' }
                ];

                onMounted(() => {
                    const saved = localStorage.getItem('tation_pro_data');
                    if (saved) {
                        groups.value = JSON.parse(saved);
                    } else {
                        groups.value = [
                            { name: "1、火锅食材准备", categories: { "肉类": [{ name: "牛肉卷 (山姆)", remark: "多买点，烤肉也能用", checked: false }] } }
                        ];
                    }
                });

                const saveData = () => localStorage.setItem('tation_pro_data', JSON.stringify(groups.value));
                
                const toggleCheck = (item) => {
                    item.checked = !item.checked;
                    saveData();
                };

                const onCatConfirm = ({ selectedOptions }) => {
                    tempItem.value.catName = selectedOptions[0].text;
                    showPicker.value = false;
                };

                const addGroup = () => {
                    if (newGroupName.value) {
                        groups.value.push({ name: newGroupName.value, categories: {} });
                        newGroupName.value = '';
                        saveData();
                    }
                };

                const openItemDialog = (gIndex) => {
                    currentGroupIndex.value = gIndex;
                    tempItem.value = { catName: '肉类', name: '', remark: '' };
                    itemDialog.value = true;
                };

                const addItem = () => {
                    if (!tempItem.value.name) return vant.showToast('请输入名称');
                    const g = groups.value[currentGroupIndex.value];
                    const cat = tempItem.value.catName || '其他';
                    if (!g.categories[cat]) g.categories[cat] = [];
                    g.categories[cat].push({ ...tempItem.value, checked: false });
                    itemDialog.value = false;
                    saveData();
                };

                const removeItem = (gIndex, catName, iIndex) => {
                    groups.value[gIndex].categories[catName].splice(iIndex, 1);
                    if (groups.value[gIndex].categories[catName].length === 0) delete groups.value[gIndex].categories[catName];
                    saveData();
                };

                const removeGroup = (index) => {
                    vant.showConfirmDialog({ title: '确认删除', message: '将清空该模块下所有食材' }).then(() => {
                        groups.value.splice(index, 1);
                        saveData();
                    });
                };

                const exportImage = () => {
                    isExporting.value = true;
                    vant.showLoadingToast({ message: '正在生成长图...', forbidClick: true });
                    setTimeout(() => {
                        html2canvas(document.getElementById('capture-area'), {
                            scale: 3, // 超高清
                            backgroundColor: '#f7f8fa',
                            useCORS: true
                        }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `Tation清单_${new Date().getTime()}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                            isExporting.value = false;
                            vant.closeToast();
                        });
                    }, 500);
                };

                return { groups, isExporting, showAddGroup, newGroupName, itemDialog, tempItem, showPicker, commonCats, onCatConfirm, openItemDialog, addItem, addGroup, removeGroup, removeItem, exportImage, saveData, toggleCheck };
            }
        }).use(vant).mount('#app');
    </script>
</body>
</html>
